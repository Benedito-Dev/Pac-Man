<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>LÃ³gica Geral dos Fantasmas - Sistema Completo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 40px;
            color: #333;
        }
        h1 {
            color: #6a1b9a;
            border-bottom: 3px solid #6a1b9a;
            padding-bottom: 10px;
        }
        h2 {
            color: #1976d2;
            margin-top: 30px;
        }
        h3 {
            color: #388e3c;
            margin-top: 25px;
        }
        pre {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .highlight {
            background-color: #fff3cd;
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
        .code-block {
            background-color: #263238;
            color: #ffffff;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
    </style>
</head>
<body>

<h1>ğŸ‘» LÃ“GICA GERAL DOS FANTASMAS - SISTEMA COMPLETO</h1>

<div class="highlight">
<h2>ğŸ¯ <strong>CONCEITO FUNDAMENTAL</strong></h2>
<p>Todos os fantasmas compartilham a <strong>mesma mÃ¡quina de estados</strong> com 5 estados possÃ­veis. A diferenÃ§a entre eles estÃ¡ apenas nos <strong>pontos de patrulha</strong> e <strong>posiÃ§Ãµes iniciais</strong>.</p>
</div>

<hr>

<h2>ğŸ”§ <strong>ARQUITETURA DO SISTEMA</strong></h2>

<h3><strong>COMPONENTES PRINCIPAIS</strong></h3>
<pre>
ğŸ‘» Ghost (Area2D)
â”œâ”€â”€ ğŸ§­ NavigationAgent2D - Sistema de navegaÃ§Ã£o
â”œâ”€â”€ ğŸ‘ï¸ EyesSprite - Olhos que mudam direÃ§Ã£o
â”œâ”€â”€ ğŸ¨ BodySprite - Corpo com cores e animaÃ§Ãµes
â”œâ”€â”€ â° ScatterTimer - Timer para patrulha (8s)
â”œâ”€â”€ â° AtHomeTimer - Timer para ficar em casa
â”œâ”€â”€ â° UpdateChasingTargetPositionTimer - Atualiza posiÃ§Ã£o do Pacman
â”œâ”€â”€ â° RunAwayTimer - Timer para fuga
â””â”€â”€ ğŸ·ï¸ PointsLabel - Mostra pontos quando comido
</pre>

<h3><strong>RECURSOS EXTERNOS</strong></h3>
<pre>
ğŸ“ MovementTargets (Resource)
â”œâ”€â”€ scatter_targets[4] - 4 pontos de patrulha Ãºnicos por fantasma
â””â”€â”€ at_home_targets[2] - 2 pontos na base (movimento vertical)

ğŸ¯ ReferÃªncias
â”œâ”€â”€ chasing_target: Node2D - ReferÃªncia ao Pacman
â”œâ”€â”€ tile_map: MazeTileMap - Mapa para navegaÃ§Ã£o
â”œâ”€â”€ points_manager: PointsManager - Sistema de pontuaÃ§Ã£o
â””â”€â”€ starting_position: Node2D - PosiÃ§Ã£o inicial
</pre>

<hr>

<h2>ğŸ® <strong>MÃQUINA DE ESTADOS COMPLETA</strong></h2>

<table>
<tr>
<th>Estado</th>
<th>Comportamento</th>
<th>DuraÃ§Ã£o</th>
<th>CondiÃ§Ãµes de SaÃ­da</th>
<th>PrÃ³ximo Estado</th>
</tr>
<tr>
<td><strong>STARTING_AT_HOME</strong></td>
<td>Fica na base se movendo verticalmente</td>
<td>Timer variÃ¡vel</td>
<td>Timer expira</td>
<td>SCATTER</td>
</tr>
<tr>
<td><strong>SCATTER</strong></td>
<td>Patrulha entre 4 pontos especÃ­ficos</td>
<td>8 segundos</td>
<td>Timer expira</td>
<td>CHASE</td>
</tr>
<tr>
<td><strong>CHASE</strong></td>
<td>Persegue Pacman diretamente</td>
<td>Indefinido</td>
<td>Power pellet comido / ColisÃ£o</td>
<td>RUN_AWAY / Pacman morre</td>
</tr>
<tr>
<td><strong>RUN_AWAY</strong></td>
<td>Foge para posiÃ§Ã£o aleatÃ³ria</td>
<td>Timer variÃ¡vel</td>
<td>Timer expira / Comido</td>
<td>CHASE / EATEN</td>
</tr>
<tr>
<td><strong>EATEN</strong></td>
<td>Volta para casa (sÃ³ olhos)</td>
<td>AtÃ© chegar</td>
<td>Chegou em casa</td>
<td>CHASE</td>
</tr>
</table>

<hr>

<h2>âš™ï¸ <strong>FLUXO DETALHADO DE FUNCIONAMENTO</strong></h2>

<h3><strong>1. INICIALIZAÃ‡ÃƒO</strong></h3>
<pre>
ğŸ® Jogo inicia
â†“
ğŸ‘» Ghost._ready() Ã© chamado
â†“
ğŸ”§ setup() Ã© chamado via call_deferred
â†“
ğŸ“ position = starting_position.position
â†“
ğŸ§­ NavigationAgent2D Ã© configurado com o mapa
â†“
â“ is_starting_at_home?
   â”œâ”€ âœ… SIM â†’ start_at_home()
   â””â”€ âŒ NÃƒO â†’ scatter()
</pre>

<h3><strong>2. MOVIMENTO CONTÃNUO</strong></h3>
<pre>
ğŸ”„ _process(delta) - Executado todo frame
â†“
ğŸ” Verifica se estÃ¡ piscando (metade do tempo de fuga)
â†“
ğŸš¶ move_ghost(navigation_agent_2d.get_next_path_position(), delta)
â†“
ğŸ“ calculate_direction(new_velocity) - Calcula direÃ§Ã£o do movimento
â†“
ğŸ‘ï¸ direction_change.emit(direction) - Atualiza olhos
â†“
ğŸ“ position += new_velocity - Move o fantasma
</pre>

<h3><strong>3. SISTEMA DE NAVEGAÃ‡ÃƒO</strong></h3>
<pre>
ğŸ¯ navigation_agent_2d.target_position = destino
â†“
ğŸ§­ NavigationAgent2D calcula caminho automaticamente
â†“
ğŸ“ get_next_path_position() retorna prÃ³ximo ponto
â†“
ğŸš¶ Fantasma se move em direÃ§Ã£o ao ponto
â†“
âœ… target_reached signal Ã© emitido quando chega
â†“
âš¡ on_position_reached() Ã© chamado
</pre>

<hr>

<h2>ğŸ¯ <strong>LÃ“GICA DE CADA ESTADO</strong></h2>

<h3><strong>STARTING_AT_HOME</strong></h3>
<div class="code-block">
func start_at_home():
    current_state = GhostState.STARTING_AT_HOME
    at_home_timer.start()
    navigation_agent_2d.target_position = movement_targets.at_home_targets[current_at_home_index].position

func move_to_next_home_position():
    current_at_home_index = 1 if current_at_home_index == 0 else 0 
    navigation_agent_2d.target_position = movement_targets.at_home_targets[current_at_home_index].position
</div>

<h3><strong>SCATTER</strong></h3>
<div class="code-block">
func scatter():
    scatter_timer.start()  # 8 segundos
    current_state = GhostState.SCATTER
    navigation_agent_2d.target_position = movement_targets.scatter_targets[current_scatter_index].position

func scatter_position_reached():
    if current_scatter_index < 3:
        current_scatter_index += 1
    else:
        current_scatter_index = 0
    navigation_agent_2d.target_position = movement_targets.scatter_targets[current_scatter_index].position
</div>

<h3><strong>CHASE</strong></h3>
<div class="code-block">
func start_chasing_pacman():
    current_state = GhostState.CHASE
    update_chasing_target_position_timer.start()
    navigation_agent_2d.target_position = chasing_target.position

func _on_update_chasing_target_position_timer_timeout():
    navigation_agent_2d.target_position = chasing_target.position  # Atualiza constantemente
</div>

<h3><strong>RUN_AWAY</strong></h3>
<div class="code-block">
func run_away_from_pacman():
    if run_away_timer.is_stopped():
        body_sprite.run_away()  # Fica azul
        eyes_sprite.hide_eyes()
        run_away_timer.start()
    
    current_state = GhostState.RUN_AWAY
    update_chasing_target_position_timer.stop()
    scatter_timer.stop()
    
    var empty_cell_position = tile_map.get_random_empty_cell_position()
    navigation_agent_2d.target_position = empty_cell_position
</div>

<h3><strong>EATEN</strong></h3>
<div class="code-block">
func get_eaten():
    ghost_eaten_sound_player.play()
    body_sprite.hide()  # SÃ³ olhos
    eyes_sprite.show_eyes()
    points_label.show()
    await points_manager.pause_on_ghost_eaten()
    points_label.hide()
    run_away_timer.stop()
    current_state = GhostState.EATEN
    navigation_agent_2d.target_position = movement_targets.at_home_targets[0].position
</div>

<hr>

<h2>ğŸ¨ <strong>SISTEMA VISUAL</strong></h2>

<h3><strong>BODY SPRITE</strong></h3>
<pre>
ğŸ¨ BodySprite gerencia aparÃªncia do corpo:
â”œâ”€â”€ move() - Cor normal + animaÃ§Ã£o "moving"
â”œâ”€â”€ run_away() - Cor branca + animaÃ§Ã£o "running_away"
â”œâ”€â”€ start_blinking() - AnimaÃ§Ã£o "blinking" (fim da fuga)
â””â”€â”€ hide() - Esconde corpo (quando comido)
</pre>

<h3><strong>EYES SPRITE</strong></h3>
<pre>
ğŸ‘ï¸ EyesSprite gerencia direÃ§Ã£o dos olhos:
â”œâ”€â”€ on_direction_change() - Muda textura baseado na direÃ§Ã£o
â”œâ”€â”€ hide_eyes() - Esconde olhos (durante fuga)
â””â”€â”€ show_eyes() - Mostra olhos (normal/comido)
</pre>

<hr>

<h2>ğŸ”„ <strong>EVENTOS E SINAIS</strong></h2>

<table>
<tr>
<th>Sinal</th>
<th>Quando Emitido</th>
<th>Efeito</th>
</tr>
<tr>
<td>direction_change</td>
<td>DireÃ§Ã£o do movimento muda</td>
<td>Atualiza textura dos olhos</td>
</tr>
<tr>
<td>run_away_timeout</td>
<td>Timer de fuga expira</td>
<td>Volta para CHASE</td>
</tr>
<tr>
<td>target_reached</td>
<td>Chega no destino</td>
<td>Chama on_position_reached()</td>
</tr>
<tr>
<td>body_entered</td>
<td>ColisÃ£o com Pacman</td>
<td>Come Pacman ou Ã© comido</td>
</tr>
</table>

<hr>

<h2>ğŸ§  <strong>RESUMO MENTAL DO SISTEMA</strong></h2>

<div class="highlight">
<p><strong>Pense no sistema assim:</strong></p>
<ol>
<li><strong>Todos os fantasmas sÃ£o idÃªnticos</strong> - mesma lÃ³gica, mesmos estados</li>
<li><strong>DiferenÃ§a estÃ¡ nos dados</strong> - pontos de patrulha e cores</li>
<li><strong>NavigationAgent2D faz a mÃ¡gica</strong> - vocÃª sÃ³ diz "vÃ¡ para X"</li>
<li><strong>Estados controlam comportamento</strong> - cada estado tem sua lÃ³gica</li>
<li><strong>Timers controlam transiÃ§Ãµes</strong> - quando mudar de estado</li>
<li><strong>Sprites controlam visual</strong> - como aparecer em cada estado</li>
</ol>

<p><strong>Fluxo simplificado:</strong></p>
<ul>
<li>ğŸ  ComeÃ§a em casa ou patrulhando</li>
<li>ğŸš¶ Patrulha por 8 segundos</li>
<li>ğŸ¯ Persegue Pacman indefinidamente</li>
<li>ğŸ˜± Foge quando Pacman come power pellet</li>
<li>ğŸ’€ Volta pra casa quando comido</li>
<li>ğŸ”„ Repete o ciclo</li>
</ul>
</div>

</body>
</html>